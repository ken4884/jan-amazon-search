<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>JANスキャン → Amazon検索</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: sans-serif;
      padding: 20px;
      margin: 0;
    }
    #appContainer {
      max-width: 480px;
      margin: 0 auto; /* 中央寄せ */
    }
    h2 {
      margin-bottom: 12px;
    }
    #janInput {
      width: 100%;
      font-size: 24px;
      padding: 12px;
    }
    #controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 10px;
      margin-bottom: 16px;
    }
    #controls button {
      width: 100%;
      font-size: 18px;
      padding: 10px;
    }
    #historyTitle {
      margin-top: 16px;
      margin-bottom: 4px;
      font-weight: bold;
    }
    #historyList {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    #historyList li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 4px 0;
      border-bottom: 1px solid #ddd;
      font-size: 16px;
      gap: 8px;
    }
    #historyList .jan-link {
      text-decoration: underline;
      color: #0645ad;
      word-break: break-all;
      flex: 1;
    }
    #historyList .btn-group {
      display: flex;
      gap: 4px;
    }
    #historyList button {
      font-size: 13px;
      padding: 3px 6px;
    }
    #copyAllBtn,
    #clearAllBtn {
      margin-top: 8px;
      font-size: 14px;
      padding: 6px 8px;
      width: 100%;
    }
  </style>
</head>
<body>
  <div id="appContainer">
    <h2>JANコードをスキャンしてください</h2>

    <input id="janInput" autofocus placeholder="ここにスキャン" />

    <div id="controls">
      <button id="searchBtn">検索</button>
      <button id="clearBtn">クリア</button>
      <button id="favBtn">♡ 保存</button>
    </div>

    <div id="historyArea">
      <div id="historyTitle">保存したJAN（最大100件）</div>
      <ul id="historyList"></ul>
      <button id="copyAllBtn" style="display:none;">履歴をコピー</button>
      <button id="clearAllBtn" style="display:none;">履歴を全削除</button>
    </div>
  </div>

  <script>
    const input = document.getElementById('janInput');
    const searchBtn = document.getElementById('searchBtn');
    const favBtn = document.getElementById('favBtn');
    const clearBtn = document.getElementById('clearBtn');
    const historyList = document.getElementById('historyList');
    const copyAllBtn = document.getElementById('copyAllBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');

    const STORAGE_KEY = 'janFavorites';
    const MAX_ITEMS = 100;

    // ---------- フォーカス制御 ----------
    function forceFocus() {
      if (document.activeElement !== input) {
        input.focus();
      }
    }

    window.addEventListener('load', forceFocus);
    window.addEventListener('focus', forceFocus);
    setInterval(forceFocus, 1000);

    // ---------- 履歴の読み書き ----------
    function loadHistory() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        return arr;
      } catch (e) {
        console.error('履歴の読み込みに失敗:', e);
        return [];
      }
    }

    function saveHistory(arr) {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      } catch (e) {
        console.error('履歴の保存に失敗:', e);
      }
    }

    function renderHistory() {
      const history = loadHistory();
      historyList.innerHTML = '';

      if (history.length === 0) {
        copyAllBtn.style.display = 'none';
        clearAllBtn.style.display = 'none';
        return;
      }

      history.forEach((jan, index) => {
        const li = document.createElement('li');

        // クリックでAmazon検索するリンク
        const link = document.createElement('a');
        link.textContent = jan;
        link.href = 'https://www.amazon.co.jp/s?k=' + encodeURIComponent(jan);
        link.className = 'jan-link';

        // ボタン群（削除のみ）
        const btnGroup = document.createElement('div');
        btnGroup.className = 'btn-group';

        const delBtn = document.createElement('button');
        delBtn.textContent = '削除';
        delBtn.addEventListener('click', () => {
          const h = loadHistory();
          h.splice(index, 1);
          saveHistory(h);
          renderHistory();
        });

        btnGroup.appendChild(delBtn);

        li.appendChild(link);
        li.appendChild(btnGroup);
        historyList.appendChild(li);
      });

      copyAllBtn.style.display = 'inline-block';
      clearAllBtn.style.display = 'inline-block';
    }

    // ---------- JAN抽出 ----------
    function extractJanFromInput() {
      const raw = input.value;
      const jan = raw.replace(/\D/g, ''); // 数字以外削除
      return jan;
    }

    // ---------- 検索共通処理 ----------
    function doSearchFromInput() {
      const jan = extractJanFromInput();

      if (!jan) {
        alert('検索できるJANがありません（入力欄が空か、数字がありません）');
        return;
      }

      // Amazon検索へ遷移
      location.href = 'https://www.amazon.co.jp/s?k=' + encodeURIComponent(jan);
    }

    // Enterキーで検索
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        doSearchFromInput();
      }
    });

    // 「検索」ボタンで検索
    searchBtn.addEventListener('click', () => {
      doSearchFromInput();
    });

    // ---------- クリアボタン ----------
    clearBtn.addEventListener('click', () => {
      input.value = '';
      forceFocus();
    });

    // ---------- ♡保存ボタン ----------
    favBtn.addEventListener('click', () => {
      const jan = extractJanFromInput();

      if (!jan) {
        alert('保存できるJANがありません（入力欄が空か、数字がありません）');
        return;
      }

      let history = loadHistory();

      // 先頭に追加（重複は許容）
      history.unshift(jan);

      // 上限100件に制限
      if (history.length > MAX_ITEMS) {
        history = history.slice(0, MAX_ITEMS);
      }

      saveHistory(history);
      renderHistory();
      // ポップアップなし（静かに保存）
    });

    // ---------- 履歴を一括コピー ----------
    copyAllBtn.addEventListener('click', async () => {
      const history = loadHistory();
      if (history.length === 0) return;

      const text = history.join('\n'); // JANごとに改行

      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(text);
        } else {
          // 古いブラウザ向けフォールバック
          const tmpInput = document.createElement('textarea');
          tmpInput.value = text;
          document.body.appendChild(tmpInput);
          tmpInput.select();
          document.execCommand('copy');
          document.body.removeChild(tmpInput);
        }
        alert('履歴をコピーしました');
      } catch (e) {
        console.error('履歴のコピーに失敗:', e);
        alert('コピーに失敗しました');
      }
    });

    // ---------- 履歴全削除ボタン ----------
    clearAllBtn.addEventListener('click', () => {
      if (!confirm('保存したJANをすべて削除しますか？')) return;
      saveHistory([]);
      renderHistory();
    });

    // 初期描画
    renderHistory();
  </script>
</body>
</html>
